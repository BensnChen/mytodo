<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>å¾…åŠæ¸…å•</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    [v-cloak] { display: none; }
    body { -webkit-tap-highlight-color: transparent; }
    .todo-item { transition: all 0.3s ease; }
    @media (hover: hover) { .todo-item:hover { transform: translateY(-2px); } }
    .completed { opacity: 0.6; }
    .completed .todo-title { text-decoration: line-through; }
    button, a { touch-action: manipulation; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" v-cloak class="container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-4xl">
    
    <!-- å¤´éƒ¨ -->
    <div class="text-center mb-6 sm:mb-10">
      <h1 class="text-3xl sm:text-5xl font-bold text-gray-800 mb-2">ğŸ“ å¾…åŠæ¸…å•</h1>
      <p class="text-sm sm:text-base text-gray-600">ç®€å•é«˜æ•ˆçš„ä»»åŠ¡ç®¡ç†</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-4 gap-2 sm:gap-4 mb-4 sm:mb-8">
      <div class="bg-white rounded-xl p-3 sm:p-4 shadow-sm text-center">
        <div class="text-xl sm:text-3xl font-bold text-gray-800">{{ stats.total }}</div>
        <div class="text-xs sm:text-sm text-gray-500">å…¨éƒ¨</div>
      </div>
      <div class="bg-yellow-50 rounded-xl p-3 sm:p-4 shadow-sm text-center">
        <div class="text-xl sm:text-3xl font-bold text-yellow-600">{{ stats.pending }}</div>
        <div class="text-xs sm:text-sm text-gray-600">å¾…å¤„ç†</div>
      </div>
      <div class="bg-blue-50 rounded-xl p-3 sm:p-4 shadow-sm text-center">
        <div class="text-xl sm:text-3xl font-bold text-blue-600">{{ stats.inProgress }}</div>
        <div class="text-xs sm:text-sm text-gray-600">è¿›è¡Œä¸­</div>
      </div>
      <div class="bg-green-50 rounded-xl p-3 sm:p-4 shadow-sm text-center">
        <div class="text-xl sm:text-3xl font-bold text-green-600">{{ stats.completed }}</div>
        <div class="text-xs sm:text-sm text-gray-600">å·²å®Œæˆ</div>
      </div>
    </div>

    <!-- æ–°å¢å¾…åŠ -->
    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
      <div class="flex gap-2">
        <input v-model="newTodo.title" @keyup.enter="addTodo" type="text" placeholder="æ·»åŠ æ–°ä»»åŠ¡..."
               class="flex-1 px-3 py-2 sm:py-3 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
        <button @click="showForm = !showForm" class="px-3 py-2 bg-gray-100 rounded-lg text-lg">âš™ï¸</button>
        <button @click="addTodo" class="px-4 sm:px-6 py-2 bg-blue-600 text-white rounded-lg font-medium">æ·»åŠ </button>
      </div>
      <div v-if="showForm" class="mt-3 pt-3 border-t grid grid-cols-1 sm:grid-cols-3 gap-2">
        <select v-model="newTodo.priority" class="px-3 py-2 text-sm border rounded-lg">
          <option value="low">ğŸŸ¢ ä½ä¼˜å…ˆçº§</option>
          <option value="medium">ğŸŸ¡ ä¸­ä¼˜å…ˆçº§</option>
          <option value="high">ğŸ”´ é«˜ä¼˜å…ˆçº§</option>
        </select>
        <input v-model="newTodo.category" type="text" placeholder="åˆ†ç±»" class="px-3 py-2 text-sm border rounded-lg">
        <input v-model="newTodo.due_date" type="date" class="px-3 py-2 text-sm border rounded-lg">
      </div>
    </div>

    <!-- ç­›é€‰ -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button v-for="f in filters" :key="f.value" @click="filter = f.value"
              :class="['px-3 py-1.5 rounded-full text-xs sm:text-sm font-medium transition',
                       filter === f.value ? f.activeClass : 'bg-white text-gray-600']">
        {{ f.label }}
      </button>
    </div>

    <!-- åŠ è½½ä¸­ -->
    <div v-if="loading" class="text-center py-12">
      <div class="text-4xl mb-4">â³</div>
      <p class="text-gray-500">åŠ è½½ä¸­...</p>
    </div>

    <!-- å¾…åŠåˆ—è¡¨ -->
    <div v-else class="space-y-2">
      <div v-for="todo in filteredTodos" :key="todo.id"
           :class="['todo-item bg-white rounded-xl shadow-sm p-4', todo.status === 'completed' && 'completed']">
        <div class="flex items-start gap-3">
          <button @click="toggleStatus(todo)"
                  :class="['flex-shrink-0 w-5 h-5 rounded-full border-2 flex items-center justify-center mt-0.5',
                           todo.status === 'completed' ? 'bg-green-500 border-green-500' :
                           todo.status === 'in-progress' ? 'bg-blue-500 border-blue-500' : 'border-gray-300']">
            <span v-if="todo.status === 'completed'" class="text-white text-xs">âœ“</span>
            <span v-else-if="todo.status === 'in-progress'" class="text-white text-xs">â€¢</span>
          </button>
          <div class="flex-1 min-w-0">
            <h3 class="todo-title text-base font-medium text-gray-800 break-words">{{ todo.title }}</h3>
            <div class="flex flex-wrap gap-1.5 mt-2 text-xs">
              <span :class="priorityClass(todo.priority)">{{ priorityIcon(todo.priority) }} {{ priorityText(todo.priority) }}</span>
              <span v-if="todo.category" class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full">ğŸ·ï¸ {{ todo.category }}</span>
              <span v-if="todo.due_date" class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full">ğŸ“… {{ todo.due_date }}</span>
            </div>
          </div>
          <div class="flex gap-1">
            <button @click="editTodo(todo)" class="p-1 text-gray-400 text-lg">âœï¸</button>
            <button @click="deleteTodo(todo.id)" class="p-1 text-gray-400 text-lg">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>

      <div v-if="filteredTodos.length === 0" class="text-center py-12">
        <div class="text-5xl mb-4">ğŸ“­</div>
        <p class="text-gray-500">æš‚æ— å¾…åŠäº‹é¡¹</p>
      </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div v-if="editing" class="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50" @click.self="editing = null">
      <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full sm:max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">ç¼–è¾‘ä»»åŠ¡</h2>
        <div class="space-y-3">
          <input v-model="editForm.title" type="text" placeholder="æ ‡é¢˜" class="w-full px-4 py-2 border rounded-lg">
          <div class="grid grid-cols-2 gap-3">
            <select v-model="editForm.status" class="px-4 py-2 border rounded-lg">
              <option value="pending">å¾…å¤„ç†</option>
              <option value="in-progress">è¿›è¡Œä¸­</option>
              <option value="completed">å·²å®Œæˆ</option>
            </select>
            <select v-model="editForm.priority" class="px-4 py-2 border rounded-lg">
              <option value="low">ä½</option>
              <option value="medium">ä¸­</option>
              <option value="high">é«˜</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <input v-model="editForm.category" type="text" placeholder="åˆ†ç±»" class="px-4 py-2 border rounded-lg">
            <input v-model="editForm.due_date" type="date" class="px-4 py-2 border rounded-lg">
          </div>
        </div>
        <div class="flex gap-3 mt-6">
          <button @click="editing = null" class="flex-1 py-2 bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button @click="saveEdit" class="flex-1 py-2 bg-blue-600 text-white rounded-lg">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    // Supabase é…ç½®ï¼ˆanon key æ˜¯å…¬å¼€çš„ï¼Œé€šè¿‡ RLS æ§åˆ¶æƒé™ï¼‰
    const SUPABASE_URL = 'https://cgmnvqrhdkfgeejawsdr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbW52cXJoZGtmZ2VlamF3c2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTMwNTksImV4cCI6MjA4NTUyOTA1OX0.A8qLLfQBvQ5czHTUXZLly6oAckpW1QwFCmibogKdfvA';

    createApp({
      setup() {
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // çŠ¶æ€
        const loading = ref(true);
        const todos = ref([]);
        const filter = ref('');
        const showForm = ref(false);
        const editing = ref(null);
        
        // æ–°å¢è¡¨å•
        const newTodo = reactive({
          title: '', priority: 'medium', category: '', due_date: ''
        });
        
        // ç¼–è¾‘è¡¨å•
        const editForm = reactive({
          title: '', status: 'pending', priority: 'medium', category: '', due_date: ''
        });

        // ç­›é€‰é€‰é¡¹
        const filters = [
          { value: '', label: 'å…¨éƒ¨', activeClass: 'bg-gray-800 text-white' },
          { value: 'pending', label: 'å¾…å¤„ç†', activeClass: 'bg-yellow-500 text-white' },
          { value: 'in-progress', label: 'è¿›è¡Œä¸­', activeClass: 'bg-blue-500 text-white' },
          { value: 'completed', label: 'å·²å®Œæˆ', activeClass: 'bg-green-500 text-white' }
        ];

        // è®¡ç®—å±æ€§
        const stats = computed(() => ({
          total: todos.value.length,
          pending: todos.value.filter(t => t.status === 'pending').length,
          inProgress: todos.value.filter(t => t.status === 'in-progress').length,
          completed: todos.value.filter(t => t.status === 'completed').length
        }));

        const filteredTodos = computed(() => {
          if (!filter.value) return todos.value;
          return todos.value.filter(t => t.status === filter.value);
        });

        // åŠ è½½å¾…åŠ
        const loadTodos = async () => {
          loading.value = true;
          try {
            const { data, error } = await supabase
              .from('todos')
              .select('*')
              .order('created_at', { ascending: false });
            if (error) throw error;
            todos.value = data || [];
          } catch (e) {
            console.error('åŠ è½½å¤±è´¥:', e);
            alert('åŠ è½½å¤±è´¥ï¼š' + e.message);
          } finally {
            loading.value = false;
          }
        };

        // æ·»åŠ å¾…åŠ
        const addTodo = async () => {
          if (!newTodo.title.trim()) {
            alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
            return;
          }
          try {
            const { error } = await supabase.from('todos').insert([{
              title: newTodo.title,
              status: 'pending',
              priority: newTodo.priority,
              category: newTodo.category || null,
              due_date: newTodo.due_date || null
            }]);
            if (error) throw error;
            newTodo.title = '';
            newTodo.category = '';
            newTodo.due_date = '';
            showForm.value = false;
            await loadTodos();
          } catch (e) {
            alert('æ·»åŠ å¤±è´¥ï¼š' + e.message);
          }
        };

        // åˆ‡æ¢çŠ¶æ€
        const toggleStatus = async (todo) => {
          const statusMap = { 'pending': 'in-progress', 'in-progress': 'completed', 'completed': 'pending' };
          try {
            const { error } = await supabase
              .from('todos')
              .update({ status: statusMap[todo.status] })
              .eq('id', todo.id);
            if (error) throw error;
            await loadTodos();
          } catch (e) {
            alert('æ›´æ–°å¤±è´¥ï¼š' + e.message);
          }
        };

        // ç¼–è¾‘å¾…åŠ
        const editTodo = (todo) => {
          editing.value = todo;
          editForm.title = todo.title;
          editForm.status = todo.status;
          editForm.priority = todo.priority;
          editForm.category = todo.category || '';
          editForm.due_date = todo.due_date || '';
        };

        // ä¿å­˜ç¼–è¾‘
        const saveEdit = async () => {
          if (!editForm.title.trim()) {
            alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
            return;
          }
          try {
            const { error } = await supabase
              .from('todos')
              .update({
                title: editForm.title,
                status: editForm.status,
                priority: editForm.priority,
                category: editForm.category || null,
                due_date: editForm.due_date || null
              })
              .eq('id', editing.value.id);
            if (error) throw error;
            editing.value = null;
            await loadTodos();
          } catch (e) {
            alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
          }
        };

        // åˆ é™¤å¾…åŠ
        const deleteTodo = async (id) => {
          if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
          try {
            const { error } = await supabase.from('todos').delete().eq('id', id);
            if (error) throw error;
            await loadTodos();
          } catch (e) {
            alert('åˆ é™¤å¤±è´¥ï¼š' + e.message);
          }
        };

        // ä¼˜å…ˆçº§è¾…åŠ©å‡½æ•°
        const priorityIcon = (p) => ({ high: 'ğŸ”´', medium: 'ğŸŸ¡', low: 'ğŸŸ¢' }[p] || 'âšª');
        const priorityText = (p) => ({ high: 'é«˜', medium: 'ä¸­', low: 'ä½' }[p] || p);
        const priorityClass = (p) => ({
          high: 'px-2 py-0.5 bg-red-100 text-red-700 rounded-full',
          medium: 'px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full',
          low: 'px-2 py-0.5 bg-green-100 text-green-700 rounded-full'
        }[p] || 'px-2 py-0.5 bg-gray-100 text-gray-700 rounded-full');

        // åˆå§‹åŒ–
        onMounted(() => {
          loadTodos();
        });

        return {
          loading, todos, filter, showForm, editing,
          newTodo, editForm, filters,
          stats, filteredTodos,
          loadTodos, addTodo, toggleStatus,
          editTodo, saveEdit, deleteTodo,
          priorityIcon, priorityText, priorityClass
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
